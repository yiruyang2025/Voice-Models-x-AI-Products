# Cell 1: Install only non-conflicting dependencies
!nvidia-smi
# Keep pandas and tensorflow at Colab defaults; install others
!pip install --upgrade --no-deps moviepy ipywidgets gdown librosa soundfile


# Cell 2: Download the 8 s silent video from Drive
import gdown, os

file_id = "11ds3js8chaDxicFnztKefvMPBjAouH8a"
gdown.download(
    f"https://drive.google.com/uc?export=download&id={file_id}",
    "video_silent.mp4",
    quiet=False
)
assert os.path.exists("video_silent.mp4"), "Failed to download video_silent.mp4"
print("Downloaded silent video")

%%bash
# Cell 3: Download ESC-50 and UrbanSound8K folds 1–3 only if not already present

# ESC-50
if [ ! -d "ESC-50-master" ]; then
  echo "Downloading ESC-50 dataset..."
  wget -q https://github.com/karolpiczak/ESC-50/archive/master.zip -O esc50.zip
  unzip -q esc50.zip
  rm esc50.zip
else
  echo "ESC-50 already exists — skipping."
fi

# UrbanSound8K folds 1–3 and metadata
if [ ! -d "UrbanSound8K/audio/fold1" ]; then
  echo "Downloading UrbanSound8K folds 1–3..."
  wget -q https://zenodo.org/record/1203745/files/UrbanSound8K.tar.gz -O us8k.tar.gz
  mkdir -p UrbanSound8K
  tar -xzf us8k.tar.gz \
      "UrbanSound8K/audio/fold1/" \
      "UrbanSound8K/audio/fold2/" \
      "UrbanSound8K/audio/fold3/" \
      "UrbanSound8K/metadata/UrbanSound8K.csv"
  rm us8k.tar.gz
else
  echo "UrbanSound8K folds 1–3 already exist — skipping."
fi

# Cell X: Inspect ESC-50 directory
!find ESC-50-master -maxdepth 2 -type f | head -n 20

!ls ESC-50-master/meta


# Cell 4: Load, trim, and extract log-Mel features for three classes using Excel metadata

import pandas as pd
import librosa
import numpy as np
import tensorflow as tf
import os

# Audio params
sr = 48000
duration = 5.0
max_len = int(sr * duration)

def load_and_trim(path):
    y, _ = librosa.load(path, sr=sr)
    if len(y) < max_len:
        y = np.tile(y, int(np.ceil(max_len/len(y))))[:max_len]
    else:
        y = y[:max_len]
    return y

def extract_logmel(y):
    S = librosa.feature.melspectrogram(
        y=y, sr=sr, n_mels=64, n_fft=2048, hop_length=512
    )
    return librosa.power_to_db(S, ref=np.max)

X, y = [], []
labels = ["Swiss","Urban","Other"]

# 1) Swiss Alps: ESC-50 “cowbell” class from Excel
esc_meta = pd.read_excel("ESC-50-master/meta/esc50-human.xlsx")
swiss_files = esc_meta[esc_meta.category=="cowbell"].filename.tolist()
for fn in swiss_files:
    path = f"ESC-50-master/audio/{fn}"
    if os.path.exists(path):
        wav = load_and_trim(path)
        X.append(extract_logmel(wav)); y.append(0)
print("Swiss samples:", sum(v==0 for v in y))

# 2) Urban US: UrbanSound8K “bell” (classID=6), folds 1–3
urb_meta = pd.read_csv("UrbanSound8K/metadata/UrbanSound8K.csv")
bell = urb_meta[(urb_meta.classID==6)&(urb_meta.fold<=3)]
for _,r in bell.iterrows():
    path = f"UrbanSound8K/audio/fold{r.fold}/{r.slice_file_name}"
    if os.path.exists(path):
        wav = load_and_trim(path)
        X.append(extract_logmel(wav)); y.append(1)
print("Urban samples:", sum(v==1 for v in y))

# 3) Other: augment first 40 Swiss cowbell files
for fn in swiss_files[:40]:
    base = load_and_trim(f"ESC-50-master/audio/{fn}")
    for rate in (0.8,1.2):
        aug = librosa.effects.time_stretch(y=base, rate=rate)
        X.append(extract_logmel(load_and_trim(aug))); y.append(2)
    for n_steps in (2,-2):
        aug = librosa.effects.pitch_shift(y=base, sr=sr, n_steps=n_steps)
        X.append(extract_logmel(load_and_trim(aug))); y.append(2)
print("Other samples:", sum(v==2 for v in y))

# Stack & one-hot encode
X = np.stack(X)[...,np.newaxis]
y_cat = tf.keras.utils.to_categorical(y, num_classes=3)
print("Dataset shapes:", X.shape, y_cat.shape)
